<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRInews - Ù¾Ø®Ø´ Ø²Ù†Ø¯Ù‡ Ùˆ ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body { font-family: Tahoma, sans-serif; direction: rtl; margin:0; padding:20px; background:#f5f5f5;}
  #headerBar { background:#007BFF; color:white; display:flex; justify-content:space-between; align-items:center; padding:10px; position:relative; }
  #headerBar button { padding:3px 8px; }
  #livePlayerContainer, #videosContainer { text-align:center; margin:20px 0; }
  #loginPanel, #addLiveForm, #addVideoForm, #aboutBox { margin-bottom:20px; }
  #loginPanel input, #addLiveForm input, #addVideoForm input { margin:0 5px; padding:5px; }
  #loginPanel button, #addLiveForm button, #addVideoForm button { padding:5px 10px; }
  #aboutBox { display:none; background:#fff; border:1px solid #ccc; padding:10px; margin-top:10px; }
  .videoCard { border:1px solid #ccc; background:#fff; padding:10px; margin:10px auto; max-width:600px; }
  .videoCard button { margin-left:5px; }
</style>
</head>
<body>

<h2>IRInews</h2>

<!-- Ù¾Ù†Ù„ ÙˆØ±ÙˆØ¯ Ùˆ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´ÛŒÚ© -->
<div id="loginPanel">
  <input type="email" id="emailInput" placeholder="Ø§ÛŒÙ…ÛŒÙ„">
  <input type="password" id="passwordInput" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±">
  <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
  <button onclick="signup()">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
  <button onclick="logout()">Ø®Ø±ÙˆØ¬</button>
  <p id="authStatus"></p>
</div>

<!-- Ù†ÙˆØ§Ø± Ø¨Ø§Ù„Ø§ÛŒ Ø³Ø§ÛŒØª -->
<div id="headerBar">
  <div id="siteName" style="font-size:20px; font-weight:bold;">Ø§ÛŒØ±Ø§Ù† Ù†ÛŒÙˆØ²</div>
  <div id="welcomeMessage" style="font-size:16px; font-weight:bold;"></div>
  <div id="flag" style="font-size:24px;">ğŸ‡®ğŸ‡·</div>
  <button onclick="toggleAbout()" style="position:absolute; right:120px;">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</button>
</div>

<!-- Ø¨Ø®Ø´ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§ -->
<div id="aboutBox">
  <h3>Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</h3>
  <p>Ø³Ù„Ø§Ù…! Ø¨Ù‡ Ø³Ø§ÛŒØª Ø§ÛŒØ±Ø§Ù† Ù†ÛŒÙˆØ² Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ.</p>
  <p>Ù„ÛŒÙ†Ú© Ú©Ø§Ù†Ø§Ù„ Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ø§Ø®Ø¨Ø§Ø± Ø¯Ù‚ÛŒÙ‚ Ùˆ Ø¨Ø±ÙˆØ² Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… Ùˆ Ø§ÛŒØªØ§: <strong>@IRInews_com</strong></p>
  <p>Ù…Ø§ Ø±Ùˆ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ù†!</p>
</div>

<!-- Ù¾Ù„ÛŒØ± Ù¾Ø®Ø´ Ø²Ù†Ø¯Ù‡ -->
<div id="livePlayerContainer"></div>

<!-- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø®Ø´ Ø²Ù†Ø¯Ù‡ (Ø§Ø¯Ù…ÛŒÙ†) -->
<div id="addLiveForm" style="display:none;">
  <input type="text" id="liveTitleInput" placeholder="Ø¹Ù†ÙˆØ§Ù† Ù¾Ø®Ø´ Ø²Ù†Ø¯Ù‡">
  <input type="text" id="liveUrlInput" placeholder="Ù„ÛŒÙ†Ú© Ù¾Ø®Ø´ Ø²Ù†Ø¯Ù‡ (telewebion ÛŒØ§ khamenei)">
  <input type="datetime-local" id="liveEndTimeInput" placeholder="Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù†">
  <button onclick="addLiveStream()">Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø®Ø´ Ø²Ù†Ø¯Ù‡</button>
</div>

<!-- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† ÙˆÛŒØ¯Ø¦Ùˆ Ø®Ø¨Ø±ÛŒ (Ø§Ø¯Ù…ÛŒÙ†) -->
<div id="addVideoForm" style="display:none;">
  <input type="text" id="videoTitleInput" placeholder="Ø¹Ù†ÙˆØ§Ù† ÙˆÛŒØ¯Ø¦Ùˆ">
  <input type="text" id="videoUrlInput" placeholder="Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯Ø¦Ùˆ">
  <button onclick="addVideo()">Ø§ÙØ²ÙˆØ¯Ù† ÙˆÛŒØ¯Ø¦Ùˆ</button>
</div>

<!-- Ø¨Ø®Ø´ Ù†Ù…Ø§ÛŒØ´ ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§ -->
<div id="videosContainer"></div>

<script>
const supabaseUrl = "https://kvetxiekvsohmsoubclo.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2ZXR4aWVzdmlkZW9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMTc3MzUsImV4cCI6MjA4MDY5MzczNX0.aaKsNfP3jIgsZSlEivVAynIVEuQCceerfmkhzkthfoc";
const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

let currentUser = null;
let currentRole = "user";

// Ù¾ÛŒØ§Ù… Ø®ÙˆØ´ Ø¢Ù…Ø¯ Ø±Ù†Ø¯ÙˆÙ…
function showWelcomeMessage() {
  const colors = ["green", "red"];
  const randomColor = colors[Math.floor(Math.random() * colors.length)];
  const messages = ["Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!", "Ø¨Ù‡ Ø³Ø§ÛŒØª Ø§ÛŒØ±Ø§Ù† Ù†ÛŒÙˆØ² Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!"];
  const randomMessage = messages[Math.floor(Math.random() * messages.length)];
  const welcomeDiv = document.getElementById("welcomeMessage");
  welcomeDiv.innerText = randomMessage;
  welcomeDiv.style.color = randomColor;
}

showWelcomeMessage();

// Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ±ÙˆØ¯
async function checkUser() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  currentUser = user;

  if(user){
    const { data: profile } = await supabaseClient
      .from("IRIusers")
      .select("role")
      .eq("email", user.email)
      .single();
    currentRole = profile?.role || "user";

    document.getElementById("authStatus").innerText = "ÙˆØ§Ø±Ø¯ Ø´Ø¯ÛŒØ¯: " + user.email;

    // ÙØ±Ù… Ø§Ø¯Ù…ÛŒÙ†
    document.getElementById("addLiveForm").style.display = (currentRole==="admin") ? "block" : "none";
    document.getElementById("addVideoForm").style.display = (currentRole==="admin") ? "block" : "none";

    loadLiveStream();
    loadVideos();
  } else {
    document.getElementById("authStatus").innerText = "ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯";
    document.getElementById("livePlayerContainer").innerHTML = "<p>Ù„Ø·ÙØ§Ù‹ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯ ØªØ§ Ù¾Ø®Ø´ Ø²Ù†Ø¯Ù‡ Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†ÛŒØ¯</p>";
    document.getElementById("addLiveForm").style.display = "none";
    document.getElementById("addVideoForm").style.display = "none";
    document.getElementById("videosContainer").innerHTML = "<p>ÙˆÛŒØ¯Ø¦ÙˆÛŒÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</p>";
  }
}

// Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…
async function signup(){
  const email = document.getElementById("emailInput").value;
  const password = document.getElementById("passwordInput").value;
  if(!email || !password){ alert("Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª"); return; }

  const { data, error } = await supabaseClient.auth.signUp({ email, password });
  if(error){ alert(error.message); } else { alert("Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚! Ø§ÛŒÙ…ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ØªØ§ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯."); }
  checkUser();
}

// ÙˆØ±ÙˆØ¯
async function login(){
  const email = document.getElementById("emailInput").value;
  const password = document.getElementById("passwordInput").value;
  if(!email || !password){ alert("Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ø±Ù…Ø² Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª"); return; }

  const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
  if(error){ alert(error.message); } 
  checkUser();
}

// Ø®Ø±ÙˆØ¬
async function logout(){
  await supabaseClient.auth.signOut();
  checkUser();
}

// Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§
function toggleAbout(){
  const box = document.getElementById("aboutBox");
  box.style.display = (box.style.display === "none") ? "block" : "none";
}

// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù¾Ø®Ø´ Ø²Ù†Ø¯Ù‡
async function addLiveStream() {
  if(!currentUser || currentRole!=="admin"){ alert("ØªÙ†Ù‡Ø§ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ù¾Ø®Ø´ Ø²Ù†Ø¯Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†Ù†Ø¯"); return; }

  const title = document.getElementById("liveTitleInput").value;
  const url = document.getElementById("liveUrlInput").value;
  const end_time = document.getElementById("liveEndTimeInput").value;

  if(!title || !url || !end_time){ alert("Ø¹Ù†ÙˆØ§Ù†ØŒ Ù„ÛŒÙ†Ú© Ùˆ Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª"); return; }

  const { data, error } = await supabaseClient
    .from("IRIlive_stream")
    .insert([{ title, url, active:true, end_time }]);

  if(error){ console.log(error); alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø®Ø´ Ø²Ù†Ø¯Ù‡"); }
  else { 
    alert("Ù¾Ø®Ø´ Ø²Ù†Ø¯Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!"); 
    document.getElementById("liveTitleInput").value = "";
    document.getElementById("liveUrlInput").value = "";
    document.getElementById("liveEndTimeInput").value = "";
    loadLiveStream(); 
  }
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù¾Ø®Ø´ Ø²Ù†Ø¯Ù‡
async function loadLiveStream() {
  if(!currentUser) return;

  const { data } = await supabaseClient
    .from("IRIlive_stream")
    .select("*")
    .eq("active", true)
    .order("created_at", { ascending: false })
    .limit(1);

  const container = document.getElementById("livePlayerContainer");
  container.innerHTML = "";

  if(data && data.length > 0){
    const live = data[0];
    const iframe = document.createElement("iframe");
    iframe.src = live.url;
    iframe.width = "800";
    iframe.height = "450";
    iframe.allow = "autoplay; fullscreen";
    iframe.frameBorder = "0";
    container.appendChild(iframe);
  } else {
    container.innerHTML = "<p>Ù¾Ø®Ø´ Ø²Ù†Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</p>";
  }
}

// Ø§ÙØ²ÙˆØ¯Ù† ÙˆÛŒØ¯Ø¦Ùˆ
async function addVideo() {
  if(!currentUser || currentRole!=="admin"){ alert("ØªÙ†Ù‡Ø§ Ø§Ø¯Ù…ÛŒÙ†â€ŒÙ‡Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ ÙˆÛŒØ¯Ø¦Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†Ù†Ø¯"); return; }

  const title = document.getElementById("videoTitleInput").value;
  const url = document.getElementById("videoUrlInput").value;

  if(!title || !url){ alert("Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯Ø¦Ùˆ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª"); return; }

  const { data, error } = await supabaseClient
    .from("IRInews_videos")
    .insert([{ title, url, uploaded_by: currentUser.email, created_at: new Date() }]);

  if(error){ console.log(error); alert("Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† ÙˆÛŒØ¯Ø¦Ùˆ"); }
  else {
    alert("ÙˆÛŒØ¯Ø¦Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!");
    document.getElementById("videoTitleInput").value = "";
    document.getElementById("videoUrlInput").value = "";
    loadVideos();
  }
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙˆÛŒØ¯Ø¦ÙˆÙ‡Ø§
async function loadVideos() {
  const { data } = await supabaseClient
    .from("IRInews_videos")
    .select("*")
    .order("created_at", { ascending:false });

  const container = document.getElementById("videosContainer");
  container.innerHTML = "";

  if(data && data.length > 0){
    data.forEach(video => {
      const div = document.createElement("div");
      div.className = "videoCard";
      div.innerHTML = `
        <h4>${video.title}</h4>
        <iframe src="${video.url}" width="560" height="315" frameborder="0" allowfullscreen></iframe>
        ${currentRole==="admin" ? `<br><button onclick="editVideo(${video.id})">ÙˆÛŒØ±Ø§ÛŒØ´</button>` : ''}
      `;
      container.appendChild(div);
    });
  } else {
    container.innerHTML = "<p>ÙˆÛŒØ¯Ø¦ÙˆÛŒÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª</p>";
  }
}

// ÙˆÛŒØ±Ø§ÛŒØ´ ÙˆÛŒØ¯Ø¦Ùˆ
async function editVideo(id){
  const newTitle = prompt("Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÛŒØ¯:");
  const newUrl = prompt("Ù„ÛŒÙ†Ú© Ø¬Ø¯ÛŒØ¯:");

  if(!newTitle || !newUrl) return;

  const { data, error } = await supabaseClient
    .from("IRInews_videos")
    .update({ title: newTitle, url: newUrl, updated_at: new Date() })
    .eq("id", id);

  if(error){ alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆÛŒØ¯Ø¦Ùˆ"); console.log(error); }
  else { alert("ÙˆÛŒØ¯Ø¦Ùˆ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯"); loadVideos(); }
}

// Ø§Ù†ØªÙ‚Ø§Ù„ Ù¾Ø®Ø´ Ø²Ù†Ø¯Ù‡ Ø¨Ù‡ Ø¢Ø±Ø´ÛŒÙˆ
async function archiveLiveStream(id){
  const { data: live } = await supabaseClient
    .from("IRIlive_stream")
    .select("*")
    .eq("id", id)
    .single();

  if(!live) return;

  await supabaseClient.from("IRIlive_archive")
    .insert([{ title: live.title, url: live.url, created_at: new Date() }]);

  await supabaseClient.from("IRIlive_stream").delete().eq("id", id);
  loadLiveStream();
}

// Ø¨Ø±Ø±Ø³ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø§ÛŒØ§Ù† Ù¾Ø®Ø´
async function checkLiveEnd() {
  if(!currentUser) return;

  const { data: lives } = await supabaseClient
    .from("IRIlive_stream")
    .select("*")
    .lt("end_time", new Date())
    .eq("active", true);

  if(lives && lives.length > 0){
    for(const live of lives){
      await archiveLiveStream(live.id);
    }
  }
}

setInterval(checkLiveEnd, 30000); // Ù‡Ø± Û³Û° Ø«Ø§Ù†ÛŒÙ‡ Ø¨Ø±Ø±Ø³ÛŒ
checkUser();
</script>

</body>
</html>
