<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IRInews - پخش زنده و ویدئوها</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body { font-family: Tahoma, sans-serif; direction: rtl; margin:0; padding:20px; background:#f5f5f5;}
  #liveStreamBar { background:#dc3545; color:white; padding:10px; text-align:center; margin-bottom:20px; }
  #liveStreamBar a { color:white; text-decoration:underline; margin-left:10px; }
  #livePlayerContainer { text-align:center; margin-bottom:20px; }
  #addLiveForm { margin-bottom:20px; }
  #addLiveForm input { margin:0 5px; padding:5px; }
  #addLiveForm button { padding:5px 10px; }
</style>
</head>
<body>

<h2>پنل پخش زنده IRInews</h2>

<!-- نوار پخش زنده -->
<div id="liveStreamBar">
  <span id="liveTitle">پخش زنده فعالی وجود ندارد</span>
  <a id="liveLink" href="#" target="_blank"></a>
</div>

<!-- پلیر داخلی -->
<div id="livePlayerContainer"></div>

<!-- فرم افزودن پخش زنده -->
<div id="addLiveForm">
  <input type="text" id="liveTitleInput" placeholder="عنوان پخش زنده">
  <input type="text" id="liveUrlInput" placeholder="لینک پخش زنده (telewebion یا khamenei)">
  <input type="datetime-local" id="liveEndTimeInput" placeholder="زمان پایان">
  <button onclick="addLiveStream()">افزودن پخش زنده</button>
</div>

<script>
  // اتصال به Supabase
  const supabaseUrl = "https://kvetxiekvsohmsoubclo.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2ZXR4aWVzdm9pcyIsInJvbGUiOiJhbm9uIiwiaWF0IjoxNzY1MTE3NzM1LCJleHAiOjIwODA2OTM3MzV9.aaKsNfP3jIgsZSlEivVAynIVEuQCceerfmkhzkthfoc";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

  // بارگذاری آخرین پخش زنده
  async function loadLiveStream() {
    const { data } = await supabaseClient
      .from("IRIlive_stream")
      .select("*")
      .eq("active", true)
      .order("created_at", { ascending: false })
      .limit(1);

    const container = document.getElementById("livePlayerContainer");
    const titleSpan = document.getElementById("liveTitle");
    const linkA = document.getElementById("liveLink");

    container.innerHTML = "";

    if(data && data.length > 0){
      const live = data[0];
      titleSpan.innerText = live.title;

      // افزودن پلیر iframe
      const iframe = document.createElement("iframe");
      iframe.src = live.url;
      iframe.width = "800";
      iframe.height = "450";
      iframe.allow = "autoplay; fullscreen";
      iframe.frameBorder = "0";
      container.appendChild(iframe);

      linkA.href = live.url;
      linkA.innerText = "مشاهده پخش زنده در صفحه اصلی";
    } else {
      titleSpan.innerText = "پخش زنده فعالی وجود ندارد";
      linkA.innerText = "";
      linkA.href = "#";
    }
  }

  // افزودن پخش زنده جدید
  async function addLiveStream() {
    const title = document.getElementById("liveTitleInput").value;
    const url = document.getElementById("liveUrlInput").value;
    const end_time = document.getElementById("liveEndTimeInput").value;

    if(!title || !url || !end_time){
      alert("عنوان، لینک و زمان پایان الزامی است");
      return;
    }

    const { data, error } = await supabaseClient
      .from("IRIlive_stream")
      .insert([{ title, url, active:true, end_time }]);

    if(error){
      console.log(error);
      alert("خطا در افزودن پخش زنده");
    } else {
      alert("پخش زنده اضافه شد!");
      document.getElementById("liveTitleInput").value = "";
      document.getElementById("liveUrlInput").value = "";
      document.getElementById("liveEndTimeInput").value = "";
      loadLiveStream();
    }
  }

  // انتقال پخش زنده به آرشیو بعد از پایان
  async function archiveLiveStream(id){
    const { data: live } = await supabaseClient
      .from("IRIlive_stream")
      .select("*")
      .eq("id", id)
      .single();

    if(!live) return;

    await supabaseClient.from("IRIlive_archive")
      .insert([{ title: live.title, url: live.url, created_at: new Date() }]);

    await supabaseClient.from("IRIlive_stream").delete().eq("id", id);

    loadLiveStream();
  }

  // بررسی خودکار پخش‌های پایان یافته هر ۳۰ ثانیه
  async function checkLiveEnd() {
    const { data: lives } = await supabaseClient
      .from("IRIlive_stream")
      .select("*")
      .lt("end_time", new Date())
      .eq("active", true);

    if(lives && lives.length > 0){
      for(const live of lives){
        await archiveLiveStream(live.id);
      }
    }
  }

  setInterval(checkLiveEnd, 30000); // هر ۳۰ ثانیه اجرا شود

  // بارگذاری اولیه
  loadLiveStream();
</script>

</body>
</html>

  
